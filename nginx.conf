# ============================================
# LiteLLM Gateway nginx.conf
# ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 2025/11/10 v11.2 (ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ç‰ˆ)
# å¤‰æ›´ç‚¹:
#   - ğŸ§¹ ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’warnã«å¤‰æ›´ï¼ˆæœ¬ç•ªç’°å¢ƒå‘ã‘ï¼‰
#   - ğŸ”§ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½è·¡ã‚³ãƒ¼ãƒ‰ã®çµ±åˆãƒ»é–¢æ•°åŒ–
#   - ğŸ”§ å†—é•·ãªãƒ­ã‚°å‡ºåŠ›ã‚’é–¢æ•°å†…ã«çµ±åˆ
#   - ğŸ”§ upstreamã®æœ€é©åŒ–ï¼ˆkeepaliveè¨­å®šè¿½åŠ ï¼‰
#   - ğŸ“¦ ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ¼ãƒ‰ã¯ä¿æŒï¼ˆ#X#ã‚³ãƒ¡ãƒ³ãƒˆï¼‰
#   - ğŸ—‘ï¸ æœªä½¿ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å‰Šé™¤ï¼ˆPort 80ã® /api/token/ï¼‰
# ============================================

# ç’°å¢ƒå¤‰æ•°ã‚’nginxãƒ—ãƒ­ã‚»ã‚¹ã§åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹
env ADMIN_EMAILS;
env ADMIN_DOMAINS;
env SUPER_ADMIN_EMAIL;
env LITELLM_MASTER_KEY;
env JWT_SECRET;
env REDIS_HOST;
env REDIS_PORT;
env LITELLM_SHARED_KEY;

worker_processes auto;
error_log /var/log/nginx/error.log warn;  # â˜… debugã‹ã‚‰warnã«å¤‰æ›´
pid /var/run/nginx.pid;

events {
    worker_connections 2048;
}

http {
    client_body_temp_path /var/cache/nginx/client_temp;
    proxy_temp_path       /var/cache/nginx/proxy_temp;

    lua_package_path "/usr/local/openresty/lualib/?.lua;/usr/local/openresty/lualib/custom/?.lua;;";

    lua_shared_dict jwt_secrets 10m;
    lua_shared_dict rate_limit 10m;
    lua_shared_dict token_store 50m;

    resolver 127.0.0.11 valid=30s ipv6=off;

    # ============================================
    # åˆæœŸåŒ–å‡¦ç†
    # ============================================
    init_by_lua_block {
        -- JWT SecretåˆæœŸåŒ–
        local jwt_secret = os.getenv("JWT_SECRET")
        if not jwt_secret or jwt_secret == "" then
            jwt_secret = "fallback-secret-change-this-immediately"
            ngx.log(ngx.WARN, "JWT_SECRET not set, using fallback")
        end
        ngx.shared.jwt_secrets:set("secret", jwt_secret)

        -- Redisè¨­å®šåˆæœŸåŒ–
        local redis_host = os.getenv("REDIS_HOST") or "redis"
        local redis_port = os.getenv("REDIS_PORT") or "6379"
        ngx.shared.jwt_secrets:set("redis_host", redis_host)
        ngx.shared.jwt_secrets:set("redis_port", redis_port)
    }

    # ============================================
    # å…±é€šLuaé–¢æ•°ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½è·¡ï¼‰
    # ============================================
    init_worker_by_lua_block {
        -- ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½è·¡
        _G.track_user = function(email)
            if not email or email == "" then
                return
            end

            ngx.log(ngx.INFO, "Tracking user: ", email)

            local res = ngx.location.capture("/track_user_internal", {
                method = ngx.HTTP_GET,
                args = { __email = email },
                header = { ["Cookie"] = ngx.var.http_cookie }
            })

            if res.status ~= 200 then
                ngx.log(ngx.WARN, "User tracking failed: ", email, " status: ", res.status, " body: ", res.body)
            else
                ngx.log(ngx.INFO, "User tracking success: ", email)
            end
        end
    }

    # ============================================
    # Upstreamå®šç¾©
    # ============================================
    upstream openresty_internal {
        server 127.0.0.1:8080;
        keepalive 32;
        keepalive_requests 100;
        keepalive_timeout 60s;
    }

    upstream oauth2_proxy_backend {
        server oauth2-proxy:4180;
        keepalive 16;
        keepalive_requests 100;
        keepalive_timeout 60s;
    }

    upstream litellm_backend {
        server litellm:4000;
        keepalive 32;
        keepalive_requests 100;
        keepalive_timeout 60s;
    }

    # ============================================
    # å…±é€šè¨­å®šãƒãƒƒãƒ—
    # ============================================
    map $upstream_http_x_auth_request_user $auth_user {
        default $upstream_http_x_auth_request_user;
    }

    map $upstream_http_x_auth_request_email $auth_email {
        default $upstream_http_x_auth_request_email;
    }

    # ============================================
    # å¤–éƒ¨å…¬é–‹ã‚µãƒ¼ãƒãƒ¼ (Port 80)
    # ============================================
    server {
        listen 80;
        server_name litellm.nakacya.jp;

        # ============================================
        # ç®¡ç†è€…ç”¨API - OAuth2èªè¨¼å¿…é ˆ
        # ============================================
        location ~ ^/api/admin/(tokens|sessions) {
            #X# access_log /var/log/nginx/admin_post.log up;
            #X# # POST ã® I/O ã‚’çŸ­ã‚ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§è¦‹ãˆã‚‹åŒ–
            #X# proxy_connect_timeout  2s;
            #X# proxy_send_timeout     10s;
            #X# proxy_read_timeout     15s;
            #X# proxy_next_upstream    off;
            #X# proxy_set_header Expect "";
            auth_request /oauth2/auth;
            error_page 401 = /oauth2/sign_in;

            auth_request_set $user $upstream_http_x_auth_request_user;
            auth_request_set $email $upstream_http_x_auth_request_email;

            proxy_request_buffering off;
            client_body_buffer_size 1m;
            client_max_body_size 1m;

            proxy_pass http://openresty_internal;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-User $user;
            proxy_set_header X-Forwarded-Email $email;
        }

        # ============================================
        # OAuth2ä¿è­·ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆå…±é€šå‡¦ç†ï¼‰
        # ============================================

        # MCPé–¢é€£ï¼ˆç®¡ç†è€…ç”¨ï¼‰
        location ~ ^/v1/(mcp|internal) {
            auth_request /oauth2/auth;
            error_page 401 = /oauth2/sign_in;

            auth_request_set $user $upstream_http_x_auth_request_user;
            auth_request_set $email $upstream_http_x_auth_request_email;

            access_by_lua_block {
                _G.track_user(ngx.var.email)
            }

            proxy_pass http://openresty_internal;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-User $user;
            proxy_set_header X-Forwarded-Email $email;
        }

        # UIãƒ»ç®¡ç†ç”»é¢
        location ~ ^/(ui|admin) {
            auth_request /oauth2/auth;
            error_page 401 = /oauth2/sign_in;

            auth_request_set $user $upstream_http_x_auth_request_user;
            auth_request_set $email $upstream_http_x_auth_request_email;

            access_by_lua_block {
                _G.track_user(ngx.var.email)
            }

            proxy_pass http://openresty_internal;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-User $user;
            proxy_set_header X-Forwarded-Email $email;
        }

        # Keyç®¡ç†API - Cookieèªè¨¼
        location = /key/generate {
            access_by_lua_block {
                local cookie_header = ngx.var.http_cookie
                if not cookie_header or not string.find(cookie_header, "_oauth2_proxy=") then
                    ngx.status = 401
                    ngx.header["Content-Type"] = "application/json"
                    ngx.say('{"error": "Authentication required. Please log in first."}')
                    return ngx.exit(401)
                end
            }

            proxy_pass http://openresty_internal/key/generate;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Cookie $http_cookie;

            proxy_buffer_size 16k;
            proxy_buffers 8 16k;
            proxy_busy_buffers_size 32k;
        }

        # ãã®ä»–ã®Keyç®¡ç†API
        location ~ ^/(key|user|team|organization)/ {
            auth_request /oauth2/auth;
            error_page 401 = /oauth2/sign_in;

            auth_request_set $user $upstream_http_x_auth_request_user;
            auth_request_set $email $upstream_http_x_auth_request_email;

            access_by_lua_block {
                _G.track_user(ngx.var.email)
            }

            proxy_pass http://openresty_internal;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-User $user;
            proxy_set_header X-Forwarded-Email $email;

            proxy_buffer_size 16k;
            proxy_buffers 8 16k;
            proxy_busy_buffers_size 32k;
        }

        # å†…éƒ¨ç”¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½è·¡ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
        location = /track_user_internal {
            internal;
            proxy_pass http://openresty_internal/track_user_internal$is_args$args;
            proxy_set_header X-Forwarded-Email $arg___email;
            proxy_http_version 1.1;
            proxy_set_header Cookie $http_cookie;
            proxy_set_header Host $host;
            proxy_set_header Connection "";
            proxy_pass_request_headers on;
        }

        # LLM API
        location /v1/ {
            proxy_pass http://openresty_internal;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
            proxy_read_timeout 600s;
            proxy_connect_timeout 10s;
            proxy_buffering off;
            proxy_cache off;
        }

        # ============================================
        # ğŸ—‘ï¸ å‰Šé™¤æ¸ˆã¿: Port 80ã® /api/token/ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
        # å‰Šé™¤æ—¥: 2025/11/10
        # ç†ç”±: OAuth2 Proxyã«ãƒ—ãƒ­ã‚­ã‚·ã•ã‚Œã‚‹ãŒæ©Ÿèƒ½ã›ãšï¼ˆæœªä½¿ç”¨ã‚’ç¢ºèªï¼‰
        # å®Ÿéš›ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯Port 8080ã§å‡¦ç†ã•ã‚Œã¦ã„ã‚‹
        # è©³ç´°: NGINX_UNUSED_ENDPOINTS_ANALYSIS_20251110.md å‚ç…§
        # ============================================

        # OAuth2 Proxyï¼ˆèªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰
        location /oauth2/ {
            proxy_pass http://oauth2_proxy_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /oauth2/auth {
            proxy_pass http://oauth2_proxy_backend/oauth2/auth;

            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header Content-Type "";

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Uri $request_uri;

            proxy_connect_timeout 1s;
            proxy_read_timeout 2s;
            proxy_send_timeout 2s;
            proxy_next_upstream off;
        }

        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆOAuth2 ProxyçµŒç”±ï¼‰
        location / {
            auth_request /oauth2/auth;
            error_page 401 = /oauth2/sign_in;

            auth_request_set $user $upstream_http_x_auth_request_user;
            auth_request_set $email $upstream_http_x_auth_request_email;

            access_by_lua_block {
                _G.track_user(ngx.var.email)
            }

            proxy_pass http://oauth2_proxy_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-User $user;
            proxy_set_header X-Forwarded-Email $email;
        }
    }

    # ============================================
    # å†…éƒ¨å‡¦ç†ã‚µãƒ¼ãƒãƒ¼ (Port 8080)
    # ============================================
    server {
        listen 8080;
        server_name localhost;

        # ============================================
        # ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†API
        # ============================================
        location = /api/token/generate {
            content_by_lua_file /usr/local/openresty/lualib/custom/token_generator.lua;
        }

        location = /api/token/info {
            content_by_lua_file /usr/local/openresty/lualib/custom/token_info.lua;
        }

        location = /api/token/revoke {
            content_by_lua_file /usr/local/openresty/lualib/custom/token_revoke.lua;
        }

        location = /api/token/list {
            content_by_lua_file /usr/local/openresty/lualib/custom/token_list.lua;
        }

        # ============================================
        # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½è·¡
        # ============================================
        location = /track_user_internal {
            content_by_lua_file /usr/local/openresty/lualib/custom/active_user_tracker.lua;
        }

        # ============================================
        # ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        # ============================================
        location /debug-headers {
            default_type application/json;
            content_by_lua_block {
                local cjson = require "cjson"
                local headers = {
                    x_forwarded_user = ngx.var.http_x_forwarded_user,
                    x_forwarded_email = ngx.var.http_x_forwarded_email,
                    x_auth_request_user = ngx.var.http_x_auth_request_user,
                    x_auth_request_email = ngx.var.http_x_auth_request_email,
                    admin_emails_env = os.getenv("ADMIN_EMAILS"),
                    admin_domains_env = os.getenv("ADMIN_DOMAINS"),
                    super_admin_email_env = os.getenv("SUPER_ADMIN_EMAIL")
                }
                ngx.say(cjson.encode(headers))
            }
        }

        location /health {
            access_log off;
            default_type application/json;
            return 200 '{"status":"healthy"}\n';
        }

        # ============================================
        # Prometheusãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆèªè¨¼ä¸è¦ï¼‰
        # ============================================
        location /metrics {
            access_log off;
            default_type text/plain;

            proxy_pass http://litellm_backend/metrics;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ============================================
        # Keyç®¡ç†API
        # ============================================
        location = /key/generate {
            access_by_lua_file /usr/local/openresty/lualib/custom/key_generate_handler.lua;

            proxy_pass http://litellm_backend/key/generate;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            proxy_buffer_size 16k;
            proxy_buffers 8 16k;
            proxy_busy_buffers_size 32k;
            proxy_read_timeout 60s;
            proxy_connect_timeout 10s;
        }

        location ~ ^/(key|user|team|organization)/ {
            access_by_lua_file /usr/local/openresty/lualib/custom/admin_check.lua;

            proxy_pass http://litellm_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            proxy_buffer_size 16k;
            proxy_buffers 8 16k;
            proxy_busy_buffers_size 32k;
        }

        # ============================================
        # ã‚³ã‚¹ãƒˆãƒ»äºˆç®—ç®¡ç†APIï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
        # ============================================
        location /spend/ {
            access_by_lua_file /usr/local/openresty/lualib/custom/admin_check.lua;

            proxy_pass http://litellm_backend/spend/;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ============================================
        # UIãƒ»ç®¡ç†ç”»é¢
        # ============================================
        location ~ ^/(ui|admin) {
            access_by_lua_file /usr/local/openresty/lualib/custom/admin_check.lua;

            proxy_pass http://litellm_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ç®¡ç†è€…ç®¡ç†ç”»é¢ï¼ˆã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…å°‚ç”¨ï¼‰
        location = /admin-manager {
            default_type text/html;
            alias /usr/local/openresty/nginx/html/admin_manager.html;
            access_by_lua_file /usr/local/openresty/lualib/custom/oauth_check.lua;
        }

        # ç®¡ç†è€…ç®¡ç†APIï¼ˆã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…å°‚ç”¨ï¼‰
        location = /api/admin/manage {
            access_by_lua_file /usr/local/openresty/lualib/custom/oauth_check.lua;
            content_by_lua_file /usr/local/openresty/lualib/custom/admin_manager.lua;
        }

        # Token/Sessionçµ±åˆç®¡ç†ç”»é¢ï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰
        location = /token-session-manager {
            default_type text/html;
            alias /usr/local/openresty/nginx/html/token_session_manager.html;
            access_by_lua_file /usr/local/openresty/lualib/custom/oauth_check.lua;
        }

        # Tokenç®¡ç†APIï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰
        location ~ ^/api/admin/tokens {
            lua_need_request_body on;
            access_by_lua_file /usr/local/openresty/lualib/custom/oauth_check.lua;
            content_by_lua_file /usr/local/openresty/lualib/custom/token_admin.lua;
        }

        # Sessionç®¡ç†APIï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰
        location ~ ^/api/admin/sessions {
            lua_need_request_body on;
            access_by_lua_file /usr/local/openresty/lualib/custom/oauth_check.lua;
            content_by_lua_file /usr/local/openresty/lualib/custom/session_admin.lua;
        }

        # Tokenç®¡ç†ç”»é¢ï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰
        location /token-manager {
            default_type text/html;
            alias /usr/local/openresty/nginx/html/token_manager.html;
            access_by_lua_file /usr/local/openresty/lualib/custom/oauth_check.lua;
        }

        # ç®¡ç†ç”»é¢ãƒ—ãƒ­ã‚­ã‚·
        location /admin/ {
            access_by_lua_file /usr/local/openresty/lualib/custom/admin_check.lua;

            proxy_pass http://litellm_backend/;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Authenticated-User $http_x_authenticated_user;
            proxy_set_header X-Authenticated-Email $http_x_authenticated_email;
        }

        # ============================================
        # å†…éƒ¨APIï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
        # ============================================
        location ~ ^/v1/(mcp|internal) {
            access_by_lua_file /usr/local/openresty/lualib/custom/admin_check.lua;

            proxy_pass http://litellm_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ============================================
        # LLM API
        # ============================================
        location /v1/messages {
            set $litellm_user_id "";
            set $litellm_user_email "";
            set $litellm_metadata "";

            lua_need_request_body on;
            access_by_lua_file /usr/local/openresty/lualib/custom/auth_handler.lua;

            proxy_pass http://litellm_backend/v1/messages;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Content-Type "application/json";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-LiteLLM-User-ID $litellm_user_id;
            proxy_set_header X-LiteLLM-User-Email $litellm_user_email;
            proxy_set_header X-LiteLLM-Metadata $litellm_metadata;

            proxy_read_timeout 600s;
            proxy_connect_timeout 10s;
            proxy_buffering off;
        }

        location /v1/ {
            set $litellm_user_id "";
            set $litellm_user_email "";
            set $litellm_metadata "";

            lua_need_request_body on;
            access_by_lua_file /usr/local/openresty/lualib/custom/auth_handler.lua;

            proxy_pass http://litellm_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Content-Type "application/json";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-LiteLLM-User-ID $litellm_user_id;
            proxy_set_header X-LiteLLM-User-Email $litellm_user_email;
            proxy_set_header X-LiteLLM-Metadata $litellm_metadata;

            proxy_read_timeout 600s;
            proxy_connect_timeout 10s;
            proxy_buffering off;
        }

        # ============================================
        # SSO
        # ============================================
        location /sso/ {
            lua_need_request_body on;
            access_by_lua_file /usr/local/openresty/lualib/custom/admin_check.lua;

            proxy_pass http://litellm_backend/sso/;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_read_timeout 600s;
        }

        # ============================================
        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        # ============================================
        location / {
            lua_need_request_body on;
            access_by_lua_file /usr/local/openresty/lualib/custom/oauth_check.lua;

            proxy_pass http://litellm_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
