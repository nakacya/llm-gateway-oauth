# 環境変数をnginxプロセスで利用可能にする
env ADMIN_EMAILS;
env ADMIN_DOMAINS;
env SUPER_ADMIN_EMAIL;
env LITELLM_MASTER_KEY;
env JWT_SECRET;
env REDIS_HOST;
env REDIS_PORT;
env LITELLM_SHARED_KEY;

worker_processes auto;
error_log /var/log/nginx/error.log debug;  # debug に変更
pid /var/run/nginx.pid;

events {
    worker_connections 2048;
}

http {
    lua_package_path "/usr/local/openresty/lualib/?.lua;/usr/local/openresty/lualib/custom/?.lua;;";

    lua_shared_dict jwt_secrets 10m;
    lua_shared_dict rate_limit 10m;
    lua_shared_dict token_store 50m;

    resolver 127.0.0.11 valid=30s ipv6=off;

    init_by_lua_block {
        local jwt_secret = os.getenv("JWT_SECRET")
        if not jwt_secret or jwt_secret == "" then
            jwt_secret = "fallback-secret-change-this-immediately"
            ngx.log(ngx.WARN, "JWT_SECRET not set, using fallback")
        end
        ngx.shared.jwt_secrets:set("secret", jwt_secret)
        ngx.log(ngx.INFO, "JWT secret initialized")

        local redis_host = os.getenv("REDIS_HOST") or "redis"
        local redis_port = os.getenv("REDIS_PORT") or "6379"
        ngx.shared.jwt_secrets:set("redis_host", redis_host)
        ngx.shared.jwt_secrets:set("redis_port", redis_port)
    }

    upstream openresty_internal {
        server 127.0.0.1:8080;
        keepalive 32;
    }

    upstream oauth2_proxy_backend {
        server oauth2-proxy:4180;
        keepalive 16;
    }

    upstream litellm_backend {
        server litellm:4000;
        keepalive 32;
    }

    server {
        listen 80;
        server_name litellm.nakacya.jp;
        
        # MCP関連（管理者用）
        location ~ ^/v1/(mcp|internal) {
            auth_request /oauth2/auth;
            error_page 401 = /oauth2/sign_in;

            auth_request_set $user $upstream_http_x_auth_request_user;
            auth_request_set $email $upstream_http_x_auth_request_email;

            proxy_pass http://openresty_internal;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header X-Forwarded-User $user;
            proxy_set_header X-Forwarded-Email $email;
        }

        location ~ ^/(ui|admin) {
            auth_request /oauth2/auth;
            error_page 401 = /oauth2/sign_in;

            auth_request_set $user $upstream_http_x_auth_request_user;
            auth_request_set $email $upstream_http_x_auth_request_email;

            proxy_pass http://openresty_internal;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header X-Forwarded-User $user;
            proxy_set_header X-Forwarded-Email $email;
        }

        # ★ Key管理API - Cookie認証でOAuth2 Proxyをバイパス
        location = /key/generate {
            # auth_requestは使わない（POSTでタイムアウトするため）
            # 代わりにCookieを直接検証
            
            access_by_lua_block {
                -- Cookie から OAuth2セッションを確認
                local cookie_header = ngx.var.http_cookie
                
                if not cookie_header or not string.find(cookie_header, "_oauth2_proxy=") then
                    ngx.log(ngx.WARN, "No OAuth2 cookie found for /key/generate")
                    ngx.status = 401
                    ngx.header["Content-Type"] = "application/json"
                    ngx.say('{"error": "Authentication required. Please log in first."}')
                    return ngx.exit(401)
                end
                
                -- Cookieが存在すれば、OAuth2 Proxyでセッション検証済みと見なす
                -- Port 8080に転送（そこでユーザー情報を取得）
                ngx.log(ngx.INFO, "OAuth2 cookie found, forwarding to port 8080")
            }

            proxy_pass http://openresty_internal/key/generate;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Cookie $http_cookie;
            
            proxy_buffer_size 16k;
            proxy_buffers 8 16k;
            proxy_busy_buffers_size 32k;
        }

        # その他のKey管理API
        location ~ ^/(key|user|team|organization)/ {
            auth_request /oauth2/auth;
            error_page 401 = /oauth2/sign_in;

            auth_request_set $user $upstream_http_x_auth_request_user;
            auth_request_set $email $upstream_http_x_auth_request_email;

            proxy_pass http://openresty_internal;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header X-Forwarded-User $user;
            proxy_set_header X-Forwarded-Email $email;
            
            proxy_buffer_size 16k;
            proxy_buffers 8 16k;
            proxy_busy_buffers_size 32k;
        }

        location /v1/ {
            proxy_pass http://openresty_internal;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
            proxy_read_timeout 600s;
            proxy_connect_timeout 10s;
            proxy_buffering off;
            proxy_cache off;
        }

        location /api/token/ {
            proxy_pass http://oauth2_proxy_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location / {
            proxy_pass http://oauth2_proxy_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    server {
        listen 8080;
        server_name localhost;

        location = /api/token/generate {
            content_by_lua_file /usr/local/openresty/lualib/custom/token_generator.lua;
        }

        location = /api/token/info {
            content_by_lua_file /usr/local/openresty/lualib/custom/token_info.lua;
        }

        location = /api/token/revoke {
            content_by_lua_file /usr/local/openresty/lualib/custom/token_revoke.lua;
        }

        location = /api/token/list {
            content_by_lua_file /usr/local/openresty/lualib/custom/token_list.lua;
        }

        location /debug-headers {
            default_type application/json;
            content_by_lua_block {
                local cjson = require "cjson"
                local headers = {
                    x_forwarded_user = ngx.var.http_x_forwarded_user,
                    x_forwarded_email = ngx.var.http_x_forwarded_email,
                    x_auth_request_user = ngx.var.http_x_auth_request_user,
                    x_auth_request_email = ngx.var.http_x_auth_request_email,
                    admin_emails_env = os.getenv("ADMIN_EMAILS"),
                    admin_domains_env = os.getenv("ADMIN_DOMAINS"),
                    super_admin_email_env = os.getenv("SUPER_ADMIN_EMAIL"),
                }
                ngx.say(cjson.encode(headers))
            }
        }

        # ★ /key/generate - Virtual Key発行（Cookie認証 + MASTER_KEY自動付与）
        location = /key/generate {
            access_by_lua_file /usr/local/openresty/lualib/custom/key_generate_handler.lua;

            proxy_pass http://litellm_backend/key/generate;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            proxy_buffer_size 16k;
            proxy_buffers 8 16k;
            proxy_busy_buffers_size 32k;
            
            proxy_read_timeout 60s;
            proxy_connect_timeout 10s;
        }

        location ~ ^/(ui|admin) {
            access_by_lua_file /usr/local/openresty/lualib/custom/admin_check.lua;

            proxy_pass http://litellm_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # その他のKey管理API（admin_checkを使用）
        location ~ ^/(key|user|team|organization)/ {
            access_by_lua_file /usr/local/openresty/lualib/custom/admin_check.lua;

            proxy_pass http://litellm_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            proxy_buffer_size 16k;
            proxy_buffers 8 16k;
            proxy_busy_buffers_size 32k;
        }

        location ~ ^/v1/(mcp|internal) {
            access_by_lua_file /usr/local/openresty/lualib/custom/admin_check.lua;
            proxy_pass http://litellm_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /v1/messages {
            # ★ nginx変数を定義
            set $litellm_user_id "";
            set $litellm_user_email "";
            set $litellm_metadata "";
            
            lua_need_request_body on;
            access_by_lua_file /usr/local/openresty/lualib/custom/auth_handler.lua;
            
            proxy_pass http://litellm_backend/v1/messages;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Content-Type "application/json";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
            # ★ nginx変数から転送
            proxy_set_header X-LiteLLM-User-ID $litellm_user_id;
            proxy_set_header X-LiteLLM-User-Email $litellm_user_email;
            proxy_set_header X-LiteLLM-Metadata $litellm_metadata;
        
            proxy_read_timeout 600s;
            proxy_connect_timeout 10s;
            proxy_buffering off;
        }
        
        location /v1/ {
            # ★ ここも同様に
            set $litellm_user_id "";
            set $litellm_user_email "";
            set $litellm_metadata "";
            
            lua_need_request_body on;
            access_by_lua_file /usr/local/openresty/lualib/custom/auth_handler.lua;
            
            proxy_pass http://litellm_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Content-Type "application/json";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
            proxy_set_header X-LiteLLM-User-ID $litellm_user_id;
            proxy_set_header X-LiteLLM-User-Email $litellm_user_email;
            proxy_set_header X-LiteLLM-Metadata $litellm_metadata;
        
            proxy_read_timeout 600s;
            proxy_connect_timeout 10s;
            proxy_buffering off;
        }

        location /health {
            access_log off;
            default_type application/json;
            return 200 '{"status":"healthy"}\n';
        }

        location /admin/ {
            access_by_lua_file /usr/local/openresty/lualib/custom/admin_check.lua;

            proxy_pass http://litellm_backend/;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            proxy_set_header X-Authenticated-User $http_x_authenticated_user;
            proxy_set_header X-Authenticated-Email $http_x_authenticated_email;
        }

        location /token-manager {
            default_type text/html;
            alias /usr/local/openresty/nginx/html/token_manager.html;
            access_by_lua_file /usr/local/openresty/lualib/custom/oauth_check.lua;
        }

        location /sso/ {
            lua_need_request_body on;
            access_by_lua_file /usr/local/openresty/lualib/custom/admin_check.lua;
            proxy_pass http://litellm_backend/sso/;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_read_timeout 600s;
        }

        location / {
            lua_need_request_body on;
            access_by_lua_file /usr/local/openresty/lualib/custom/oauth_check.lua;
            proxy_pass http://litellm_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
