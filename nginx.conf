# ============================================
# LiteLLM Gateway nginx.conf
# ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 2025/11/05 v10 (ChatGPTææ¡ˆ: headerãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä½¿ç”¨ç‰ˆ)
# å¤‰æ›´ç‚¹:
#   - ğŸ”§ ngx.location.capture ã® header ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç›´æ¥æ¸¡ã™
#   - ğŸ”§ set $tracking_email ã¯ä¸è¦ï¼ˆå¤‰æ•°ã‚¹ã‚³ãƒ¼ãƒ—å•é¡Œã‚’å›é¿ï¼‰
#   - ğŸ”§ Port 80 ã® /track_user_internal ã‚’å˜ç´”åŒ–
#   - Prometheusãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¿½åŠ 
#   - /admin-manager ç®¡ç†ç”»é¢è¿½åŠ ï¼ˆã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…å°‚ç”¨ï¼‰
#   - /api/admin/manage APIè¿½åŠ ï¼ˆã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…å°‚ç”¨ï¼‰
#   - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½è·¡æ©Ÿèƒ½è¿½åŠ ï¼ˆactive_user_tracker.luaï¼‰
#   - OAuth2èªè¨¼å¾Œã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½è·¡ãƒ•ãƒƒã‚¯è¿½åŠ 
# ============================================

# ç’°å¢ƒå¤‰æ•°ã‚’nginxãƒ—ãƒ­ã‚»ã‚¹ã§åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹
env ADMIN_EMAILS;
env ADMIN_DOMAINS;
env SUPER_ADMIN_EMAIL;
env LITELLM_MASTER_KEY;
env JWT_SECRET;
env REDIS_HOST;
env REDIS_PORT;
env LITELLM_SHARED_KEY;

worker_processes auto;
error_log /var/log/nginx/error.log debug;
pid /var/run/nginx.pid;

events {
    worker_connections 2048;
}

http {
log_format up '$remote_addr - "$request" cl=$content_length expect="$http_expect" '
              'rt=$request_time urt=$upstream_response_time '
              'sent=$bytes_sent ustat=$upstream_status';

    client_body_temp_path /var/cache/nginx/client_temp;
    proxy_temp_path       /var/cache/nginx/proxy_temp;

    lua_package_path "/usr/local/openresty/lualib/?.lua;/usr/local/openresty/lualib/custom/?.lua;;";

    lua_shared_dict jwt_secrets 10m;
    lua_shared_dict rate_limit 10m;
    lua_shared_dict token_store 50m;

    resolver 127.0.0.11 valid=30s ipv6=off;

    init_by_lua_block {
        local jwt_secret = os.getenv("JWT_SECRET")
        if not jwt_secret or jwt_secret == "" then
            jwt_secret = "fallback-secret-change-this-immediately"
            ngx.log(ngx.WARN, "JWT_SECRET not set, using fallback")
        end
        ngx.shared.jwt_secrets:set("secret", jwt_secret)
        ngx.log(ngx.INFO, "JWT secret initialized")

        local redis_host = os.getenv("REDIS_HOST") or "redis"
        local redis_port = os.getenv("REDIS_PORT") or "6379"
        ngx.shared.jwt_secrets:set("redis_host", redis_host)
        ngx.shared.jwt_secrets:set("redis_port", redis_port)
    }

    upstream openresty_internal {
        server 127.0.0.1:8080;
        keepalive 32;
    }

    upstream oauth2_proxy_backend {
        server oauth2-proxy:4180;
        keepalive 16;
    }

    upstream litellm_backend {
        server litellm:4000;
        keepalive 32;
    }

    # ============================================
    # å¤–éƒ¨å…¬é–‹ã‚µãƒ¼ãƒãƒ¼ (Port 80)
    # ============================================
    server {
        listen 80;
        server_name litellm.nakacya.jp;

        # ============================================
        # ğŸ”§ ç®¡ç†è€…ç”¨API - OAuth2èªè¨¼å¿…é ˆ
        # ============================================
        location ~ ^/api/admin/(tokens|sessions) {
            #X# access_log /var/log/nginx/admin_post.log up;
            #X# # POST ã® I/O ã‚’çŸ­ã‚ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§è¦‹ãˆã‚‹åŒ–
            #X# proxy_connect_timeout  2s;
            #X# proxy_send_timeout     10s;
            #X# proxy_read_timeout     15s;
            #X# proxy_next_upstream    off;
            #X# proxy_set_header Expect "";
            auth_request /oauth2/auth;
            error_page 401 = /oauth2/sign_in;

            proxy_request_buffering off; 
            client_body_buffer_size 1m;
            client_max_body_size 1m;

            auth_request_set $user $upstream_http_x_auth_request_user;
            auth_request_set $email $upstream_http_x_auth_request_email;

            proxy_pass http://openresty_internal;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header X-Forwarded-User $user;
            proxy_set_header X-Forwarded-Email $email;
        }

        # ============================================
        # OAuth2èªè¨¼å¾Œã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½è·¡
        # ã™ã¹ã¦ã®OAuth2ä¿è­·ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§å®Ÿè¡Œ
        # ============================================

        # MCPé–¢é€£ï¼ˆç®¡ç†è€…ç”¨ï¼‰
        location ~ ^/v1/(mcp|internal) {
            auth_request /oauth2/auth;
            error_page 401 = /oauth2/sign_in;

            auth_request_set $user $upstream_http_x_auth_request_user;
            auth_request_set $email $upstream_http_x_auth_request_email;

            # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½è·¡
            access_by_lua_block {
                local email = ngx.var.email

                if email and email ~= "" then
                    local res = ngx.location.capture("/track_user_internal", {
                        method = ngx.HTTP_GET,
                        args = { __email = email },
                        header = { ["Cookie"] = ngx.var.http_cookie },
                    })

                    if res.status ~= 200 then
                        ngx.log(ngx.WARN, "User tracking failed: ", res.status)
                    end
                end
            }

            proxy_pass http://openresty_internal;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header X-Forwarded-User $user;
            proxy_set_header X-Forwarded-Email $email;
        }

        # UIãƒ»ç®¡ç†ç”»é¢
        location ~ ^/(ui|admin) {
            auth_request /oauth2/auth;
            error_page 401 = /oauth2/sign_in;

            auth_request_set $user $upstream_http_x_auth_request_user;
            auth_request_set $email $upstream_http_x_auth_request_email;

            # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½è·¡
            access_by_lua_block {
                local email = ngx.var.email

                if email and email ~= "" then
                    local res = ngx.location.capture("/track_user_internal", {
                        method = ngx.HTTP_GET,
                        args = { __email = email },
                        header = { ["Cookie"] = ngx.var.http_cookie },
                    })
                end
            }

            proxy_pass http://openresty_internal;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header X-Forwarded-User $user;
            proxy_set_header X-Forwarded-Email $email;
        }

        # Keyç®¡ç†API - Cookieèªè¨¼ã§OAuth2 Proxyã‚’ãƒã‚¤ãƒ‘ã‚¹
        location = /key/generate {
            access_by_lua_block {
                local cookie_header = ngx.var.http_cookie

                if not cookie_header or not string.find(cookie_header, "_oauth2_proxy=") then
                    ngx.log(ngx.WARN, "No OAuth2 cookie found for /key/generate")
                    ngx.status = 401
                    ngx.header["Content-Type"] = "application/json"
                    ngx.say('{"error": "Authentication required. Please log in first."}')
                    return ngx.exit(401)
                end

                ngx.log(ngx.INFO, "OAuth2 cookie found, forwarding to port 8080")
            }

            proxy_pass http://openresty_internal/key/generate;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Cookie $http_cookie;

            proxy_buffer_size 16k;
            proxy_buffers 8 16k;
            proxy_busy_buffers_size 32k;
        }

        # ãã®ä»–ã®Keyç®¡ç†API
        location ~ ^/(key|user|team|organization)/ {
            auth_request /oauth2/auth;
            error_page 401 = /oauth2/sign_in;

            auth_request_set $user $upstream_http_x_auth_request_user;
            auth_request_set $email $upstream_http_x_auth_request_email;

            # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½è·¡
            access_by_lua_block {
                local email = ngx.var.email

                if email and email ~= "" then
                    local res = ngx.location.capture("/track_user_internal", {
                        method = ngx.HTTP_GET,
                        args = { __email = email },
                        header = { ["Cookie"] = ngx.var.http_cookie },
                    })
                end
            }

            proxy_pass http://openresty_internal;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header X-Forwarded-User $user;
            proxy_set_header X-Forwarded-Email $email;

            proxy_buffer_size 16k;
            proxy_buffers 8 16k;
            proxy_busy_buffers_size 32k;
        }

        # å†…éƒ¨ç”¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½è·¡ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆå˜ç´”åŒ–ç‰ˆï¼‰
        location = /track_user_internal {
            internal;

            # Port 8080 ã«ãƒ—ãƒ­ã‚­ã‚·ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã¯ ngx.location.capture ã§æ¸¡ã•ã‚Œã‚‹ï¼‰
            proxy_pass http://openresty_internal/track_user_internal$is_args$args;
            proxy_set_header X-Forwarded-Email $arg___email;    # â˜…å¼•æ•°ã‚’ãƒ˜ãƒƒãƒ€åŒ–
            proxy_http_version 1.1;
            proxy_set_header Cookie $http_cookie;
            proxy_set_header Host $host;
            proxy_set_header Connection "";
            proxy_pass_request_headers on;
        }

        # LLM API
        location /v1/ {
            proxy_pass http://openresty_internal;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
            proxy_read_timeout 600s;
            proxy_connect_timeout 10s;
            proxy_buffering off;
            proxy_cache off;
        }

        # ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†API + ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½è·¡
        location /api/token/ {
            auth_request /oauth2/auth;
            error_page 401 = /oauth2/sign_in;

            auth_request_set $user $upstream_http_x_auth_request_user;
            auth_request_set $email $upstream_http_x_auth_request_email;

            # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½è·¡
            access_by_lua_block {
                local email = ngx.var.email

                if email and email ~= "" then
                    local res = ngx.location.capture("/track_user_internal", {
                        method = ngx.HTTP_GET,
                        args = { __email = email },
                        header = { ["Cookie"] = ngx.var.http_cookie },
                    })

                    if res.status ~= 200 then
                        ngx.log(ngx.WARN, "User tracking failed at /api/token/: ", res.status)
                    else
                        ngx.log(ngx.INFO, "User tracked at /api/token/: ", email)
                    end
                end
            }

            proxy_pass http://oauth2_proxy_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header X-Forwarded-User $user;
            proxy_set_header X-Forwarded-Email $email;
        }

        # OAuth2 Proxyï¼ˆèªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰
        location /oauth2/ {
            proxy_pass http://oauth2_proxy_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /oauth2/auth {
            proxy_pass http://oauth2_proxy_backend/oauth2/auth;
        
            # â˜… auth_request ã§ã¯æœ¬æ–‡ã‚’ upstream ã«æ¸¡ã•ãªã„
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header Content-Type "";
        
            proxy_set_header Host               $host;
            proxy_set_header X-Real-IP          $remote_addr;
            proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto  $scheme;
            proxy_set_header X-Forwarded-Uri    $request_uri;
        
            # åˆ‡ã‚Šåˆ†ã‘ç”¨ã®çŸ­ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆå®Ÿé‹ç”¨ã§ã‚‚ã“ã®ãã‚‰ã„ã§OKï¼‰
            proxy_connect_timeout 1s;
            proxy_read_timeout    2s;
            proxy_send_timeout    2s;
            proxy_next_upstream   off;
        }

        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆOAuth2 ProxyçµŒç”±ï¼‰ + ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½è·¡
        location / {
            auth_request /oauth2/auth;
            error_page 401 = /oauth2/sign_in;

            auth_request_set $user $upstream_http_x_auth_request_user;
            auth_request_set $email $upstream_http_x_auth_request_email;

            # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½è·¡
            access_by_lua_block {
                local email = ngx.var.email

                if email and email ~= "" then
                    ngx.log(ngx.INFO, "Tracking user: ", email)

                    local res = ngx.location.capture("/track_user_internal", {
                        method = ngx.HTTP_GET,
                        args = { __email = email },
                        header = { ["Cookie"] = ngx.var.http_cookie },
                    })

                    if res.status ~= 200 then
                        ngx.log(ngx.WARN, "User tracking failed: ", res.status, " body: ", res.body)
                    else
                        ngx.log(ngx.INFO, "User tracking success: ", email)
                    end
                end
            }

            proxy_pass http://oauth2_proxy_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header X-Forwarded-User $user;
            proxy_set_header X-Forwarded-Email $email;
        }
    }

    # ============================================
    # å†…éƒ¨å‡¦ç†ã‚µãƒ¼ãƒãƒ¼ (Port 8080)
    # ============================================
    server {
        listen 8080;
        server_name localhost;

        # ============================================
        # ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†API
        # ============================================

        location = /api/token/generate {
            content_by_lua_file /usr/local/openresty/lualib/custom/token_generator.lua;
        }

        location = /api/token/info {
            content_by_lua_file /usr/local/openresty/lualib/custom/token_info.lua;
        }

        location = /api/token/revoke {
            content_by_lua_file /usr/local/openresty/lualib/custom/token_revoke.lua;
        }

        location = /api/token/list {
            content_by_lua_file /usr/local/openresty/lualib/custom/token_list.lua;
        }

        # ============================================
        # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½è·¡ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
        # ============================================

        location = /track_user_internal {
            content_by_lua_file /usr/local/openresty/lualib/custom/active_user_tracker.lua;
        }

        # ============================================
        # ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        # ============================================

        location /debug-headers {
            default_type application/json;
            content_by_lua_block {
                local cjson = require "cjson"
                local headers = {
                    x_forwarded_user = ngx.var.http_x_forwarded_user,
                    x_forwarded_email = ngx.var.http_x_forwarded_email,
                    x_auth_request_user = ngx.var.http_x_auth_request_user,
                    x_auth_request_email = ngx.var.http_x_auth_request_email,
                    admin_emails_env = os.getenv("ADMIN_EMAILS"),
                    admin_domains_env = os.getenv("ADMIN_DOMAINS"),
                    super_admin_email_env = os.getenv("SUPER_ADMIN_EMAIL"),
                }
                ngx.say(cjson.encode(headers))
            }
        }

        location /health {
            access_log off;
            default_type application/json;
            return 200 '{"status":"healthy"}\n';
        }

        # ============================================
        # Prometheusãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆèªè¨¼ä¸è¦ï¼‰
        # ============================================

        location /metrics {
            access_log off;
            default_type text/plain;

            proxy_pass http://litellm_backend/metrics;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ============================================
        # Keyç®¡ç†API
        # ============================================

        # Virtual Keyç™ºè¡Œï¼ˆCookieèªè¨¼ + MASTER_KEYè‡ªå‹•ä»˜ä¸ï¼‰
        location = /key/generate {
            access_by_lua_file /usr/local/openresty/lualib/custom/key_generate_handler.lua;

            proxy_pass http://litellm_backend/key/generate;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            proxy_buffer_size 16k;
            proxy_buffers 8 16k;
            proxy_busy_buffers_size 32k;

            proxy_read_timeout 60s;
            proxy_connect_timeout 10s;
        }

        # ãã®ä»–ã®Keyç®¡ç†APIï¼ˆadmin_checkã‚’ä½¿ç”¨ï¼‰
        location ~ ^/(key|user|team|organization)/ {
            access_by_lua_file /usr/local/openresty/lualib/custom/admin_check.lua;

            proxy_pass http://litellm_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            proxy_buffer_size 16k;
            proxy_buffers 8 16k;
            proxy_busy_buffers_size 32k;
        }

        # ============================================
        # ã‚³ã‚¹ãƒˆãƒ»äºˆç®—ç®¡ç†APIï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
        # ============================================

        location /spend/ {
            access_by_lua_file /usr/local/openresty/lualib/custom/admin_check.lua;

            proxy_pass http://litellm_backend/spend/;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ============================================
        # UIãƒ»ç®¡ç†ç”»é¢
        # ============================================

        location ~ ^/(ui|admin) {
            access_by_lua_file /usr/local/openresty/lualib/custom/admin_check.lua;

            proxy_pass http://litellm_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ç®¡ç†è€…ç®¡ç†ç”»é¢ï¼ˆã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…å°‚ç”¨ï¼‰
        location = /admin-manager {
            default_type text/html;
            alias /usr/local/openresty/nginx/html/admin_manager.html;
            access_by_lua_file /usr/local/openresty/lualib/custom/oauth_check.lua;
        }

        # ç®¡ç†è€…ç®¡ç†APIï¼ˆã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…å°‚ç”¨ï¼‰
        location = /api/admin/manage {
            access_by_lua_file /usr/local/openresty/lualib/custom/oauth_check.lua;
            content_by_lua_file /usr/local/openresty/lualib/custom/admin_manager.lua;
        }

        # Token/Sessionçµ±åˆç®¡ç†ç”»é¢ï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰
        location = /token-session-manager {
            default_type text/html;
            alias /usr/local/openresty/nginx/html/token_session_manager.html;
            access_by_lua_file /usr/local/openresty/lualib/custom/oauth_check.lua;
        }

        # Tokenç®¡ç†APIï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰
        location ~ ^/api/admin/tokens {
            lua_need_request_body on;
            access_by_lua_file /usr/local/openresty/lualib/custom/oauth_check.lua;
            content_by_lua_file /usr/local/openresty/lualib/custom/token_admin.lua;
        }

        # Sessionç®¡ç†APIï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰
        location ~ ^/api/admin/sessions {

            lua_need_request_body on;
            access_by_lua_file /usr/local/openresty/lualib/custom/oauth_check.lua;
            content_by_lua_file /usr/local/openresty/lualib/custom/session_admin.lua;
        }

        location /token-manager {
            default_type text/html;
            alias /usr/local/openresty/nginx/html/token_manager.html;
            access_by_lua_file /usr/local/openresty/lualib/custom/oauth_check.lua;
        }

        location /admin/ {
            access_by_lua_file /usr/local/openresty/lualib/custom/admin_check.lua;

            proxy_pass http://litellm_backend/;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            proxy_set_header X-Authenticated-User $http_x_authenticated_user;
            proxy_set_header X-Authenticated-Email $http_x_authenticated_email;
        }

        # ============================================
        # å†…éƒ¨APIï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
        # ============================================

        location ~ ^/v1/(mcp|internal) {
            access_by_lua_file /usr/local/openresty/lualib/custom/admin_check.lua;
            proxy_pass http://litellm_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ============================================
        # LLM API
        # ============================================

        location /v1/messages {
            set $litellm_user_id "";
            set $litellm_user_email "";
            set $litellm_metadata "";

            lua_need_request_body on;
            access_by_lua_file /usr/local/openresty/lualib/custom/auth_handler.lua;

            proxy_pass http://litellm_backend/v1/messages;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Content-Type "application/json";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            proxy_set_header X-LiteLLM-User-ID $litellm_user_id;
            proxy_set_header X-LiteLLM-User-Email $litellm_user_email;
            proxy_set_header X-LiteLLM-Metadata $litellm_metadata;

            proxy_read_timeout 600s;
            proxy_connect_timeout 10s;
            proxy_buffering off;
        }

        location /v1/ {
            set $litellm_user_id "";
            set $litellm_user_email "";
            set $litellm_metadata "";

            lua_need_request_body on;
            access_by_lua_file /usr/local/openresty/lualib/custom/auth_handler.lua;

            proxy_pass http://litellm_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Content-Type "application/json";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            proxy_set_header X-LiteLLM-User-ID $litellm_user_id;
            proxy_set_header X-LiteLLM-User-Email $litellm_user_email;
            proxy_set_header X-LiteLLM-Metadata $litellm_metadata;

            proxy_read_timeout 600s;
            proxy_connect_timeout 10s;
            proxy_buffering off;
        }

        # ============================================
        # SSO
        # ============================================

        location /sso/ {
            lua_need_request_body on;
            access_by_lua_file /usr/local/openresty/lualib/custom/admin_check.lua;
            proxy_pass http://litellm_backend/sso/;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_read_timeout 600s;
        }

        # ============================================
        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        # ============================================

        location / {
            lua_need_request_body on;
            access_by_lua_file /usr/local/openresty/lualib/custom/oauth_check.lua;
            proxy_pass http://litellm_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
